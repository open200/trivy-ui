<script setup lang="ts">
import { ref, computed } from 'vue'
import type { VulnerabilityReport } from '~/models/vulnerability-report.model';

const props = defineProps<{
  vulnerabilityReport: VulnerabilityReport;
}>();

const emit = defineEmits(['resetSelectedReport']);

function goToVulnerabilityReport() {
  emit('resetSelectedReport');
}

const columns = [
  {
    key: 'vulnerabilityID',
    label: 'Vulnerability Id',
    sortable: false,
  },
  {
    key: 'title',
    label: 'Title',
    sortable: true,
  },
  {
    key: 'severity',
    label: 'Severity',
    sortable: true,
  },
  {
    key: 'score',
    label: 'Score',
    sortable: true,
  },
  {
    key: 'resource',
    label: 'Resource',
    sortable: true,
  },
  {
    key: 'actions',
    label: 'actions',
  },
];

const q = ref('');

const filteredRows = computed(() => {
  if (!q.value) {
    return props.vulnerabilityReport.report.vulnerabilities;
  }

  return props.vulnerabilityReport.report.vulnerabilities.filter(
    (vulnerability) => {
      return Object.values(vulnerability).some((value) => {
        return String(value).toLowerCase().includes(q.value.toLowerCase());
      });
    }
  );
});

const config = {
  base: 'table-auto',
  td: {
    base: 'whitespace-normal w-8',
    padding: 'px-3 py-4',
    color: 'text-gray-500 dark:text-gray-400',
    font: '',
    size: 'text-sm',
  },
};
</script>

<template>
  <UButton icon="i-heroicons-arrow-left" @click="goToVulnerabilityReport()"
    >Vulnerability Report
  </UButton>

  <h1 class="text-4xl mt-2">
    {{ props.vulnerabilityReport.containerName }}
  </h1>
  <h2 class="text-gray-500 text-sm">
    Id: {{ props.vulnerabilityReport.uid }} <br />
    Namespace: {{ props.vulnerabilityReport.namespace }}
  </h2>

  <div class="grid grid-cols-4 gap-4 my-4">
    <SeverityStatus
      label="Critical"
      :count="props.vulnerabilityReport.report.summary.criticalCount"
    ></SeverityStatus>
    <SeverityStatus
      label="High"
      :count="props.vulnerabilityReport.report.summary.highCount"
    ></SeverityStatus>
    <SeverityStatus
      label="Medium"
      :count="props.vulnerabilityReport.report.summary.mediumCount"
    ></SeverityStatus>
    <SeverityStatus
      label="Low"
      :count="props.vulnerabilityReport.report.summary.lowCount"
    ></SeverityStatus>
  </div>

  <div class="flex px-3 py-3.5 border-b border-gray-200 dark:border-gray-700">
    <UInput v-model="q" placeholder="Filter Vulnerabilities..." />
  </div>

  <UTable
    :ui="config"
    :columns="columns"
    :rows="filteredRows"
    :sort="{ column: '', direction: 'desc' }"
  >
    <template #actions-data="{ row }">
      <a :href="row.primaryLink" target="_blank">
        <UIcon name="i-heroicons-arrow-top-right-on-square-solid" />
      </a>
    </template>
  </UTable>
</template>
