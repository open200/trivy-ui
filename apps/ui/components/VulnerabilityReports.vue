<script setup lang="ts">
import { VulnerabilityReport } from "~/models/vulnerability-report.model";
import { Ref } from "vue";
import Keycloak from "keycloak-js";

const nuxtApp = useNuxtApp();
const keycloak = nuxtApp.$keycloak as Keycloak

const columns = [
  {
    key: 'uid',
    label: 'ID',
    sortable: false,
  },
  {
    key: 'containerName',
    label: 'Container Name',
    sortable: true,
  },
  {
    key: 'namespace',
    label: 'Namespace',
    sortable: true,
  },
  {
    key: 'report.summary.criticalCount',
    label: 'Critical',
    sortable: true,
  },
  {
    key: 'report.summary.highCount',
    label: 'High',
    sortable: true,
  },
  {
    key: 'report.summary.mediumCount',
    label: 'Medium',
    sortable: true,
  },
  {
    key: 'report.summary.lowCount',
    label: 'Low',
    sortable: true,
  },
];

const selectedReport: Ref<VulnerabilityReport | null> = ref(null);

const { pending, data: imagesWithReport, error } = await useLazyAsyncData('imagesWithReport', () => $fetch('/api/kubectl/vulnerability-report', {
  headers: {
    Authorization: `Bearer ${keycloak.token}`
  }
}))

function select (row) {
    selectedReport.value = row
}

function resetSelectedReport() {
  selectedReport.value = null
}

const availableNamespaces = computed(() => {
  return ['-', ...new Set(imagesWithReport.value?.map((report) => report.namespace) ?? [])]
})

const selectedNamespace = ref(null)

const filteredRows = computed(() => {
  if (selectedNamespace.value === null || selectedNamespace.value === '-') {
    return imagesWithReport.value;
  }

  return imagesWithReport.value.filter(
      (report) => {
        return report.namespace === selectedNamespace.value;
      }
  );
});
</script>

<template>
  <VulnerabilityReportDetail v-if="selectedReport" :vulnerabilityReport="selectedReport" @reset-selected-report="resetSelectedReport"></VulnerabilityReportDetail>
  <div v-else>
    <h1 class="text-4xl mt-2">Vulnerability Report</h1>

    <UAlert v-if="error"
        class="mt-4"
        icon="i-heroicons-command-line"
        color="red"
        variant="solid"
        title="Error!"
        :description="error.message"
    />
    <div v-else class="mt-4">
      <USelect
          v-if="!pending"
          v-model="selectedNamespace"
          placeholder="Search namespace..."
          :options="availableNamespaces"
      />
      <UTable :columns="columns" :rows="filteredRows" :sort="{ column: '' }" :loading="pending" @select="select" />
    </div>
  </div>
</template>
