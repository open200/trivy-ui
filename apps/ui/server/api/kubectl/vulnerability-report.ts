import { kubectlClient } from '@trivy-ui/kubectl-client';
import { VulnerabilityReport } from '~/models/vulnerability-report.model';

export default defineEventHandler(
  async (event): Promise<VulnerabilityReport[]> => {
    const kubeResponse = await kubectlClient();

    return kubeResponse.items.map((val): VulnerabilityReport => {
      return {
        uid: val.metadata.uid,
        containerName: val.metadata.labels['trivy-operator.container.name'],
        namespace: val.metadata.namespace,
        report: {
          summary: val.report.summary,
          vulnerabilities: val.report.vulnerabilities as any,
        },
      };
    });
  }
);
